## npm v5.0.0 and v5.0.1 package-lock.json bug demo

This demo reproduces a couple of surprising scenarios arising from the use of
the `package-lock.json` file in npm v5.0.0 and v5.0.1. The behavior described
below is reproducible with both npm versions, and appears related to the fact
that `devDependency` packages whose own dependencies have a version spec of
`latest` are not handled properly depending on the scenario. This demo uses
[live-server][] to illustrate the phenomena.

[live-server]:https://www.npmjs.com/package/live-server

### `package-lock-00.json`: clean build

This is the base case `package-lock.json` file generated in a completely new
repository, or after running:

```
$ rm -rf package-lock.json node_modules
$ npm install
```

Multiple runs of `npm install` at this point remain idempotent.

### `package-lock-01.json`: original package lock removed and regenerated

```
$ rm -rf package-lock.json node_modules
$ npm install
$ rm package-lock.json
$ npm install
```

Notice in the `fsevents` dependencies, the `version` attributes have changed
from semver numbers to npm registry URLs, such as:

```json
"fsevents": {
  "version": "1.1.1",
  "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-1.1.1.tgz",
  "integrity": "sha1-8Z/Sj0Pur3YWgOUZogPE0LPTGv8=",
  "dev": true,
  "optional": true,
  "dependencies": {
    "abbrev": {
      "version": "https://registry.npmjs.org/abbrev/-/abbrev-1.1.0.tgz",
      "integrity": "sha1-0FVMIlZjbi9W58LlrRg/hZQo2B8=",
      "dev": true,
      "optional": true
    },
    "ansi-regex": {
      "version": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-2.1.1.tgz",
      "integrity": "sha1-w7M6te42DYbg5ijwRorn7yfWVN8=",
      "dev": true
    },
```

This is similar to what I'd seen in [my original url-pointers
`package-lock.json` file][urlp-lock]. It also led to failures running [nyc][]
that appeared related to this phenomenon, thanks to
[istanbul-lib-instrument][ili] having issues with this version format.

[nyc]: https://www.npmjs.com/package/nyc
[ili]: https://www.npmjs.com/package/istanbul-lib-instrument

However, all subsequent `npm install` commands with this version of the
`package-lock.json` file remain idempotent.

Also, running `diff -uNr` between the original `node_modules` directory and the
one generated by these steps produces:

```
$ diff -uNr node_modules-00 node_modules-01
Binary files
node_modules-00/fsevents/build/Release/fse.node and
node_modules-01/fsevents/build/Release/fse.node differ
Binary files
node_modules-00/fsevents/lib/binding/Release/node-v57-darwin-x64/fse.node and
node_modules-01/fsevents/lib/binding/Release/node-v57-darwin-x64/fse.node differ
```

[urlp-lock]: https://github.com/mbland/url-pointers/blob/0a7a0d2fda287d1cf98a19d922f39c04f7300414/package-lock.json

### `package-lock-02.json`: original `node_modules` removed and regenerated

```
$ rm -rf package-lock.json node_modules
$ npm install
$ rm -rf node_modules

$ npm install
...
added 239 packages in 8.466s

$ npm install
removed 24 packages in 1.019s
```

As best I can tell, all of the removed packages are those with a version spec of
"latest" within `node_modules/live-server/package.json`, or are dependencies of
those packages, notably dependencies of `event-stream` and `opn`.

All subsequent `npm install` commands after this point remain idempotent.

Running `diff -uNr` between the original `node_modules` directory and the one
generated by these steps produces a very large diff, with the
`node_modules/live-server/package.json` diff appearing as:

```diff
diff -uNr node_modules/live-server/package.json node_modules-02/live-server/package.json
--- node_modules/live-server/package.json	2017-06-01 19:41:17.000000000 -0400
+++ node_modules-02/live-server/package.json	2017-06-01 19:35:33.000000000 -0400
@@ -1,26 +1,31 @@
 {
-  "_from": "live-server@^1.2.0",
+  "_args": [
+    [
+      "live-server@1.2.0",
+      "/Users/msb/src/mbland/npm-v5.0.1-package-lock-bug-demo"
+    ]
+  ],
+  "_from": "live-server@1.2.0",
   "_id": "live-server@1.2.0",
   "_inBundle": false,
   "_integrity": "sha1-RJhkS7+Bpm8Y3Y3/3vYcTBw3TKM=",
   "_location": "/live-server",
   "_phantomChildren": {},
   "_requested": {
-    "type": "range",
+    "type": "version",
     "registry": true,
-    "raw": "live-server@^1.2.0",
+    "raw": "live-server@1.2.0",
     "name": "live-server",
     "escapedName": "live-server",
-    "rawSpec": "^1.2.0",
+    "rawSpec": "1.2.0",
     "saveSpec": null,
-    "fetchSpec": "^1.2.0"
+    "fetchSpec": "1.2.0"
   },
   "_requiredBy": [
     "#DEV:/"
   ],
   "_resolved": "https://registry.npmjs.org/live-server/-/live-server-1.2.0.tgz",
-  "_shasum": "4498644bbf81a66f18dd8dffdef61c4c1c374ca3",
-  "_spec": "live-server@^1.2.0",
+  "_spec": "1.2.0",
   "_where": "/Users/msb/src/mbland/npm-v5.0.1-package-lock-bug-demo",
   "author": {
     "name": "Tapio Vierros"
@@ -31,7 +36,6 @@
   "bugs": {
     "url": "https://github.com/tapio/live-server/issues"
   },
-  "bundleDependencies": false,
   "dependencies": {
     "chokidar": "^1.6.0",
     "colors": "latest",
@@ -47,7 +51,6 @@
     "send": "latest",
     "serve-index": "^1.7.2"
   },
-  "deprecated": false,
   "description": "simple development http server with live reload capability",
   "devDependencies": {
     "eslint": "^3.13.0",
```

The diffs for many other `node_modules/*/packages.json` files follow a similar
pattern.

### Conclusion

Apparently, so long as neither the `package-lock.json` file or `node_modules`
directory are removed and regenerated, npm will handle both correctly. If either
are removed, and a `devDependency` package depends on packages with a version
spec of `latest`, things get out of whack.
